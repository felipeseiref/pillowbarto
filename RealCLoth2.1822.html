<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>KeyShotXR Scroll Control Revisado</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #ffffff;
      /* Hacer altura grande para mucho scroll */
      min-height: 400vh;
    }
    #KeyShotXR {
      position: sticky;
      top: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #ffffff;
      z-index: 10;
      overflow: hidden;
    }
    /* Asegurar que el contenedor interno tenga tamaño adecuado */
    #KeyShotXR img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .content-section {
      width: 100%;
      max-width: 1200px;
      margin: auto;
      padding: 40px 20px;
    }
  </style>

<script type="text/javascript" src="./RealCLoth2.1822/files/KeyShotXR.js" defer></script>
<script defer>
  var xrInstance;
  var totalFrames = 379; // <-- confirma que sea real (0..378)
  
  // Utilidad robusta de scroll
  const getScrollY = () =>
    window.pageYOffset ?? document.documentElement.scrollTop ?? document.body.scrollTop ?? 0;

  // Reemplaza el número del frame en una URL manteniendo los ceros (…_0001.png -> …_0123.png)
  function replaceFrameNumber(url, oneBasedIndex) {
    // Busca el último grupo de dígitos antes de la extensión
    const m = url.match(/(.*?)(\d+)(\.(?:png|jpg|jpeg|webp|gif))(?:\?.*)?$/i);
    if (!m) return url; // si no matchea, devolvemos igual
    const [ , prefix, digits, ext ] = m;
    const width = digits.length;                      // cantidad de dígitos (p.ej. 4)
    const next = String(oneBasedIndex).padStart(width, '0');
    return `${prefix}${next}${ext}`;
  }

  function initKeyShotXR() {
    console.log('keyshotXR typeof:', typeof keyshotXR); // debe ser "function"
    xrInstance = new keyshotXR(
      "KeyShotXR",
      "RealCLoth2.1822",   // ¡asegurate que el folder coincida EXACTO en mayúsculas/minúsculas!
      497, 883,
      "#FFFFFF",
      totalFrames, 1,
      true, false,
      -0.05, 0.05,
      totalFrames - 1, 0,
      1, 1,
      0.96,
      true, false,
      false,
      "png",
      true,
      "LOGO-03-03.png",
      true,
      false, false,
      {}, false
    );

    // Esperá a que el visor inyecte el <img>
    const ensureImg = () => document.querySelector('#KeyShotXR img');
    let img = ensureImg();
    if (!img) {
      // reintento simple si se inyecta async
      const id = setInterval(() => {
        img = ensureImg();
        if (img) { clearInterval(id); onScroll(); }
      }, 16);
    }

    function onScroll() {
      if (!img) img = ensureImg();
      if (!img) return; // aún no aparece el <img>

      const maxScroll = Math.max(1, document.body.scrollHeight - window.innerHeight);
      let t = getScrollY() / maxScroll;
      t = Math.min(Math.max(t, 0), 1);

      const idx0 = Math.floor(t * (totalFrames - 1)); // 0-based (0..378)
      const idx1 = idx0 + 1;                          // 1-based para nombres tipo _0001

      // Deducimos la URL del frame usando la URL actual como plantilla
      const nextUrl = replaceFrameNumber(img.src, idx1);
      if (img.src !== nextUrl) img.src = nextUrl;
    }

    addEventListener('scroll', onScroll, { passive: true });
    addEventListener('resize', onScroll, { passive: true });
    // Primer seteo
    requestAnimationFrame(onScroll);
  }

  addEventListener('DOMContentLoaded', initKeyShotXR);
</script>
</head>
<body oncontextmenu="return false;">
  <div id="KeyShotXR"></div>

  <section class="content-section">
    <h1>Contenido después del XR</h1>
    <p>El visor permanece fijo mientras haces scroll y la animación avanza.</p>
    <p>...</p>
  </section>
</body>
</html>
